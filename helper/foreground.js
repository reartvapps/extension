function show_output(){document.getElementById("output_outer_box")||chrome.runtime.sendMessage({message:"request_output"},(e=>{if(e.payload4){document.getElementById("wait_main_stealth")&&document.getElementById("wait_main_stealth").remove();const t=document.createElement("span");t.innerText=e.payload,t.style.position="fixed",t.style.right="10px",t.style.bottom="10px",t.style.fontSize="small",t.style.zIndex=1e3,document.body.appendChild(t),document.addEventListener("click",(e=>{if(!t.contains(e.target)){t.remove();const e=document.getElementById("output_outer_box");e&&e.remove()}}))}else buildOutputBoxUI(e)}))}function buildOutputBoxUI(e){const t=document.createElement("div"),n=document.createElement("div"),o=document.createElement("div"),i=document.createElement("div"),s=document.createElement("div"),d=document.createElement("a"),r=document.createElement("img"),a=document.createElement("div"),l=document.createElement("span"),c=document.createElement("img"),p=document.createElement("div"),m=document.createElement("div");m.setAttribute("id","analyze_container"),p.id="explain_btn",p.innerText="Explain it";const u=document.createElement("div");u.setAttribute("id","question_box"),u.innerHTML="Question : ",document.body.appendChild(u);const x=document.createElement("div");x.setAttribute("id","analyze_box"),x.innerHTML="Analyze : ",document.body.appendChild(x);const y=document.createElement("div");y.setAttribute("id","loading_spinner"),n.appendChild(y);const g=document.createElement("div");g.setAttribute("id","submit_button"),g.innerText="Answer",g.disabled=!1,u.insertAdjacentElement("afterend",g),x.insertAdjacentElement("afterend",g);const h=document.createElement("div");h.id="answer_label",h.innerText="Answer:";const b=document.createElement("div");b.id="resources_label",b.innerText="Related Resources:";const f=document.createElement("div");f.id="question_label",f.innerText="Question :",f.style.cssText="width: 380px; font-size: 18px; line-height: 24px; font-family: 'Varela Round', sans-serif; color: rgb(46, 45, 45); margin-top: 10px; margin-bottom: 5px;";const E=document.createElement("div");E.setAttribute("id","question_container"),E.appendChild(u),E.appendChild(g),m.appendChild(x),m.appendChild(g);const _=document.createElement("div"),v=document.createElement("img");_.setAttribute("id","edit_button"),v.src=chrome.runtime.getURL("./icons/Edit_Pencil.png"),_.appendChild(v),n.appendChild(_),_.addEventListener("click",(()=>{u.contentEditable="true",u.focus(),g.style.display="block",m.contentEditable="true",x.focus(),E.style.display="flex",m.style.display="flex"})),g.addEventListener("click",(()=>{if(!g.disabled){const e=u.innerText.replace("Question: ","").trim();chrome.runtime.sendMessage({message:"process_edited_text",payload:e}),g.disabled=!0,g.style.backgroundColor="grey",y.style.display="block"}}));let C=!1;x.addEventListener("scroll",(function(){C=this.scrollTop<this.scrollHeight-this.offsetHeight-10})),chrome.runtime.onMessage.addListener(((e,t,n)=>{if("update_chunked"===e.message&&function(e,t,n){function o(){const e=document.createElement("div");return e.className="skeleton-loader",e.style.width="80px",e}""===e?(i.innerHTML="",i.appendChild(o())):i.innerText=e;const s=T.querySelector(".skeleton-loader");""===n?s||T.appendChild(o()):(s&&T.removeChild(s),k.innerText=n),x.innerText=t,C||(x.scrollTop=x.scrollHeight)}(e.payload,e.payload2,e.payload3),"remove_output_box"===e.message){const e=document.getElementById("output_outer_box");e&&e.remove()}})),t.id="output_outer_box",n.id="output_inner_box",o.id="output_exit",d.id="output_exit_link",r.id="xmark",i.id="output_main_box",s.id="output_buttons",a.id="redo_btn",c.id="redo_btn_icon",r.src=chrome.runtime.getURL("./icons/Close_Grey.png"),c.src=chrome.runtime.getURL("./icons/OCR_Black.png"),l.innerHTML="Select again&nbsp;&nbsp;",a.appendChild(l),a.appendChild(c),t.appendChild(n),t.appendChild(s),n.appendChild(o);const T=document.createElement("div");T.id="subject_label",T.innerText="Subject:",T.style.cssText="width: 380px; font-size: 18px; line-height: 24px; font-family: 'Varela Round', sans-serif; color: rgb(46, 45, 45); margin-top: 10px; margin-bottom: 6px;",n.appendChild(T),n.appendChild(f),chrome.storage.sync.get(["imageVision","limit"],(e=>{e.imageVision?(m.style.display="flex",E.style.display="none"):(m.style.display="none",E.style.display="flex")})),n.appendChild(m),n.appendChild(E);const k=document.createElement("span");k.id="subject_value",k.style.cssText="font-weight: bold;",T.appendChild(k),h.appendChild(i),n.appendChild(h);const w=document.createElement("div");w.id="resources_container",n.appendChild(w),b.style.display="none",n.appendChild(b),chrome.storage.sync.get(["isPro"],(e=>{if(!e.isPro){o.style.cssText="\n                margin-bottom: 66px;\n                margin-top: -5px;\n            ";for(let e=1;e<=4;e++){const t=document.createElement("div");t.className="image_container",t.style.textAlign="center",t.style.position="relative";const o=document.createElement("img");o.src=chrome.runtime.getURL(`./resources/resourcesDefault${e}.png`),o.style.width="370px",o.style.margin="0px 0",o.style.objectFit="cover",o.style.borderRadius="12px",o.style.border="1px solid #E0E0E0",t.style.marginBottom="10px";const i=document.createElement("button");i.addEventListener("click",(()=>{chrome.runtime.sendMessage({message:"open_index_page"})})),i.style.cssText="\n                    display: flex;\n                    width: 231px;\n                    padding: 8px 12px;\n                    justify-content: center;\n                    align-items: center;\n                    border-radius: 9999px;\n                    background: linear-gradient(137deg, #007BFF 0%, #017BFF 100%);\n                    position: absolute; \n                    left: 50%; \n                    top: 50%; \n                    transform: translate(-50%, -50%); \n                    border: none;\n                    text-decoration: none;\n                    transition: background 0.3s ease;\n                    cursor: pointer;\n                ",i.onmouseover=()=>{i.style.background="linear-gradient(137deg, #005BFF 0%, #005BFF 100%)"},i.onmouseout=()=>{i.style.background="linear-gradient(137deg, #007BFF 0%, #017BFF 100%)"},i.style.display="flex",i.style.width="231px",i.style.padding="8px 12px",i.style.justifyContent="center",i.style.alignItems="center",i.style.borderRadius="9999px",i.style.background="linear-gradient(137deg, #007BFF 0%, #017BFF 100%)",i.style.position="absolute",i.style.left="50%",i.style.top="50%",i.style.transform="translate(-50%, -50%)",i.style.border="none",i.style.textDecoration="none";const s=document.createElement("span");s.innerText="Unlock Resources",s.style.color="#FFF",s.style.textAlign="center",s.style.fontFamily="Inter",s.style.fontSize="14px",s.style.fontWeight="600",i.appendChild(s);const d=document.createElement("span");d.style.marginLeft="10px",d.innerHTML="&#128275;",i.appendChild(d),t.appendChild(o),t.appendChild(i),n.appendChild(t)}}}));const F=document.createElement("div");F.id="limit_label",F.style.cssText="width: 380px; font-size: 16px; line-height: 20px; font-family: 'Varela Round', sans-serif; color: rgb(46, 45, 45); margin-top: 5px; margin-bottom: 5px;",n.appendChild(F);const L=document.createElement("div");L.id="limit_value";const R=document.createElement("div");R.id="get_more_link",R.textContent="Get Unlimited",R.style.cssText="text-decoration: underline; cursor: pointer;",R.addEventListener("click",(()=>{chrome.runtime.sendMessage({message:"open_gumroad_page"})}));const B=document.createElement("div");B.id="limit_and_more_container",B.appendChild(L),B.appendChild(R),F.appendChild(B);const A=document.createElement("img");if(A.src=chrome.runtime.getURL("./logo/logo2x2.png"),A.style.marginRight="10px",A.id="photosolve_logo",o.appendChild(A),o.appendChild(d),d.appendChild(r),s.appendChild(a),t.style.display="block","output_received"===e.message){let n=document.getElementById("wait_main");document.querySelector("body").removeChild(n),i.innerText=e.payload,u.innerText=e.payload2,x.innerText=e.payload2,chrome.storage.sync.get(["scans","isPro"],(e=>{if(e.isPro){const e=document.querySelector("#question_box");if(e){const t=e.innerText;t&&getRelatedResource(t)}}void 0!==e.scans&&(e.isPro?(L.style.display="none",F.style.display="none"):(L.style.display="block",F.style.display="block",e.scans>=11?L.innerText="10/10 answer":L.innerText=`${e.scans}/10 answer`,F.insertBefore(document.createTextNode(),R)))})),k.innerText=e.payload3,"limit reached"===e.payload?(p.disabled=!0,p.style.pointerEvents="none",p.style.backgroundColor="gray"):(p.disabled=!1,p.style.pointerEvents="auto",p.style.backgroundColor="#034ea2"),t.style.display="block"}chrome.storage.sync.get("imageVision",(e=>{e.imageVision,s.appendChild(p)})),document.querySelector("body").appendChild(t),a.addEventListener("click",(()=>{document.querySelector("body").removeChild(t),window.setTimeout((()=>{chrome.runtime.sendMessage({message:"select_area_again"},(e=>{}))}),100)})),p.addEventListener("click",(()=>{if(document.getElementById("answer_explanation_box"))return;y.style.display="block",p.style.pointerEvents="none",p.style.backgroundColor="gray";const e=u.innerText.replace("Question: ","").trim();chrome.runtime.sendMessage({message:"get_explanation",payload:{question:e,answer:i.innerText}},(e=>{if("explanation_received"===e.message){o.style.cssText="\n                margin-bottom: 66px;\n                margin-top: -5px;\n                ";const t=document.createElement("div");t.id="answer_explanation_label",t.innerText="Explanation :",t.style.cssText="width: 380px; font-size: 18px; line-height: 24px; font-family: 'Varela Round', sans-serif; color: rgb(46, 45, 45); margin-top: 10px; margin-bottom: 5px;",w.insertAdjacentElement("beforebegin",t);const i=document.createElement("div");i.id="answer_explanation_box",i.style.cssText="width: 380px; height: max-content; max-height: 300px; margin-bottom: 5px; box-sizing: border-box; overflow-x: unset; font-size: 18px; line-height: 24px; font-family: 'Varela Round', sans-serif; color: rgb(46, 45, 45); border: 1px solid rgb(230, 230, 230); border-radius: 5px; padding: 20px 20px; overflow-wrap: break-word;",w.insertAdjacentElement("beforebegin",i),n.style.height="max-content",typeWriter(e.payload,i),y.style.display="none",p.style.pointerEvents="auto",p.style.backgroundColor="#034ea2"}}))})),w.appendChild(b),r.addEventListener("click",(()=>{document.querySelector("body").removeChild(t)}))}function requestTokenFromBackground(){return new Promise(((e,t)=>{chrome.runtime.sendMessage({message:"generate_token"},(n=>{n&&"token_generated"===n.message?e(n.payload):t("Failed to generate token.")}))}))}var getRelatedResource=e=>{requestTokenFromBackground().then((t=>{const n=new XMLHttpRequest;n.open("POST","https://coral-app-opv8j.ondigitalocean.app/get_related_resource",!0),n.setRequestHeader("Content-type","application/json"),n.setRequestHeader("Authorization",`Bearer ${t}`),n.onload=function(){if(4==n.readyState&&200==n.status){const e=JSON.parse(n.responseText).relatedResource.items;e&&0!==e.length&&(resourcesLabel=document.getElementById("resources_label"),resourcesLabel.style.display="flex",e.forEach(((e,t)=>{const n=document.createElement("div");n.id=`resource-${t}`,n.style.cssText="\n                            width: 355px;\n                            border: 1px solid #E0E0E0;\n                            border-radius: 12px;\n                            padding: 15px;\n                            margin: 5px 0;\n                            display: flex;\n                            flex-direction: column;\n                            background: #FFFFFF;\n                            font-family: 'Inter', sans-serif;\n                            transition: background 0.3s;\n                            cursor: pointer;\n                        ",n.addEventListener("click",(()=>window.open(e.link,"_blank"))),n.addEventListener("mouseover",(()=>n.style.background="#d0d0d0")),n.addEventListener("mouseout",(()=>n.style.background="#FFFFFF"));const o=document.createElement("img");o.src="http://"+e.displayLink+"/favicon.ico",o.style.width="16px",o.style.height="16px",o.style.marginRight="5px";const i=document.createElement("h3");i.textContent=e.displayLink||"No Title Available",i.style.cssText="\n                            color: #007BFF;\n                            font-size: 16px;\n                            font-weight: bold;\n                            margin-bottom: 5px;\n                            white-space: nowrap; \n                            overflow: hidden;\n                            text-overflow: ellipsis; \n                            max-width: 355px;\n                        ";const s=document.createElement("p"),d=(new DOMParser).parseFromString(e.htmlSnippet||"","text/html");s.textContent=d.body.innerText||"No Description Available",s.style.cssText="\n                            color: #515151;\n                            font-size: 14px;\n                            white-space: nowrap; \n                            overflow: hidden;\n                            text-overflow: ellipsis; \n                            max-width: 355px;\n                            margin-bottom: 5px;\n                        ";const r=document.createElement("p"),a=e.pagemap.metatags[0]["article:modified_time"]||"No Published Time Available";r.textContent=a.split("T")[0],r.style.cssText="\n                            color: #515151;\n                            font-size: 14px;\n                            max-width: 355px;\n                        ",n.appendChild(o),n.appendChild(i),n.appendChild(s),n.appendChild(r),output_inner_box.appendChild(n)})))}},n.send(JSON.stringify({question:e}))})).catch((e=>{console.error("Error generating token:",e)}))};function typeWriter(e,t,n=0){n<e.length&&(t.innerHTML+=e.charAt(n),setTimeout((()=>typeWriter(e,t,n+1)),20))}document.addEventListener("DOMContentLoaded",(e=>{show_output()})),show_output();