<!DOCTYPE html>
<html lang="en">
  <head>
    <title>PhotoSolve - Extension Settings</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="main.css" />
    <style>
      /* Base styles */
      :root {
        --primary-blue: #0066FF;
        --primary-hover: #0052CC;
        --background: #F8FAFC;
        --surface: #FFFFFF;
        --surface-hover: #F8FAFC;
        --text-primary: #0A2540;
        --text-secondary: #64748B;
        --border: #E2E8F0;
        --success: #32D583;
        --warning: #FDB022;
        --radius-lg: 24px;
        --radius-md: 16px;
        --radius-sm: 12px;
        --shadow-sm: 0px 2px 8px rgba(0, 0, 0, 0.05);
        --shadow-md: 0px 8px 16px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0px 16px 24px rgba(0, 0, 0, 0.08);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --header-height: 72px;
        --container-width: 800px;
        --container-padding: 24px;
      }

      /* Global styles */
      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        width: 100%;
        background: var(--background);
        color: var(--text-primary);
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
        -webkit-font-smoothing: antialiased;
        line-height: 1.5;
      }

      /* Layout container */
      .container {
        width: 100%;
        max-width: var(--container-width);
        margin: 0 auto;
        padding: 0 var(--container-padding);
        box-sizing: border-box;
      }

      /* Header styles */
      .header-content {
        width: 100%;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: var(--header-height);
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border);
        z-index: 100;
      }

      .header-content > .container {
        height: 100%;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }

      .header-content__logo-container img {
        height: 32px;
        width: auto;
      }

      .header-content__button-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .header-content__sign-in-button,
      .header-content__get_started-button {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 600;
        transition: var(--transition);
        cursor: pointer;
      }

      .header-content__sign-in-button {
        background: transparent;
        color: var(--primary-blue);
        border: 1px solid var(--border);
      }

      .header-content__get_started-button {
        background: var(--primary-blue);
        color: white;
        border: none;
      }

      /* Main content wrapper */
      .main-wrapper {
        width: 100vw;
        min-width: 100vw;
        display: flex;
        justify-content: center;
        padding-top: calc(var(--header-height) + var(--container-padding));
        padding-bottom: var(--container-padding);
        box-sizing: border-box;
      }

      /* Main content */
      .main-content {
        width: 100%;
        max-width: var(--container-width);
        padding: 0 var(--container-padding);
        margin: 0 auto;
        box-sizing: border-box;
      }

      /* Navigation section */
      .nav-section {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
        margin-bottom: 32px;
        width: 100%;
        box-sizing: border-box;
      }

      .nav-card {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
      }

      .nav-card h2 {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 16px;
      }

      .nav-link-wrapper {
        display: flex;
        align-items: center;
        padding: 12px;
        margin: 4px 0;
        border-radius: var(--radius-md);
        color: var(--text-primary);
        text-decoration: none;
        transition: var(--transition);
        width: 100%;
      }

      .nav-link-wrapper:hover {
        background: var(--surface-hover);
        color: var(--primary-blue);
      }

      .nav-link-wrapper span:first-child {
        width: 20px;
        margin-right: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* License section */
      .license-section,
      .setting-item,
      #about {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: 32px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
        margin-bottom: 24px;
        width: 100%;
        box-sizing: border-box;
      }

      /* Form elements */
      .input-group {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        justify-content: center;
        align-items: center;
      }

      input[type="text"] {
        flex: 1;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
      }

      button {
        padding: 12px 24px;
        background: var(--primary-blue);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
      }

      /* Responsive styles */
      @media (max-width: 768px) {
        .main-content {
          padding: 0 16px;
          width: 100%;
        }

        .nav-section {
          grid-template-columns: 1fr;
          width: 100%;
        }

        .input-group {
          flex-direction: column;
        }

        button {
          width: 100%;
        }

        .license-section,
        .setting-item,
        #about {
          width: 100%;
          padding: 24px;
        }
      }

      /* Completely isolated price modal styles */
      #price-modal {
        position: absolute;
        display: none;
        left: 0;
        top: 0;
        z-index: 10;
        width: 100vw;
        height: 100vh;
        background-color: rgb(0,0,0);
        background-color: rgba(0,0,0,0.6);
      }

      #price-modal * {
        font-family: "Gotham-Rounded", "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        line-height: normal;
      }

      #price-modal h1 {
        font-size: 32px;
        margin: 24px 0;
        color: white;
        text-align: center;
      }

      #price-modal p {
        margin: 0;
        padding: 0;
      }

      .price-modal__open {
        overflow: hidden;
      }

      .price-modal__loading-overlay {
        position: fixed;
        display: none;
        z-index: 20;
        align-items: center;
        justify-content: center;
        left: 0;
        top: 0;
        width: 100%;
        height: 100dvh;
      }

      .price-modal__loading-spinner {
        animation: spin 1s linear infinite;
        color: #007BFF;
        fill: #007BFF;
      }

      .price-modal__content {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #143D6D;
        border-radius: 1.5rem;
        color: white;
        margin: 0;
        padding: 1rem;
        width: 100%;
        height: 100dvh;
        overflow: hidden;
      }

      .price-modal__content-background {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: auto;
        opacity: 0.1;
      }

      .price-modal__close-button {
        position: absolute;
        right: 1.25rem;
        top: 1.25rem;
        background-color: #D6F2FF;
        padding: 8px;
        border-radius: 100%;
        font-size: 1.25rem;
        line-height: 1.75rem;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .price-modal__close-button:hover {
        background-color: #67a6f3;
      }

      .price-modal__pro-header {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 0.5rem;
        margin-top: 24px;
      }

      .price-modal__pro-chip {
        font-weight: 600;
        border-radius: 9999px;
        padding: 4px 8px;
        background-image: linear-gradient(to bottom right, #007BFF, #064187);
      }

      .price-modal__prices {
        margin-top: 2rem;
        width: 250px;
        gap: 1rem;
        margin-bottom: 2rem;
        display: grid;
        grid-template-rows: repeat(2, minmax(0, 1fr));
      }

      .price-modal__price {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: white;
        border: 4px solid #e1e3e1;
        border-radius: 1.5rem;
        padding: 1.5rem;
        gap: 0.75rem;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .price-modal__price:hover {
        background-color: white;
        transform: scale(1.01);
      }

      .price-modal__price-type {
        font-size: 1.15em;
        line-height: 1.25rem;
        font-weight: 600;
        color: #007BFF;
      }

      .price-modal__price-value {
        font-size: 2rem;
        line-height: 1;
        font-weight: bold;
        color: black;
      }

      .price-modal__price-currency {
        font-size: 0.875rem;
        line-height: 1.25rem;
        color: #9B9B9B;
      }

      .price-modal__price-save-marker {
        position: absolute;
        bottom: -0.25rem;
        right: -0.25rem;
        border-top-left-radius: 1.5rem;
        background-color: #FFE2A9;
        color: #B87C00;
        padding: 8px 12px;
        font-size: 0.75rem;
        line-height: 1rem;
        font-weight: 500;
      }

      .price-modal__perks {
        display: flex;
        flex-direction: column;
        align-items: start;
        width: 90%;
        padding: 0 1.5rem;
        list-style: none;
        gap: 1.5rem;
      }

      .price-modal__perk {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
      }

      .price-modal__perk img {
        width: 24px;
        height: 24px;
        flex-shrink: 0;
      }

      .price-modal__perk-description {
        font-size: 1rem;
        line-height: 1.5;
        color: white;
        margin: 0;
      }

      .price-modal__perk-description strong {
        font-weight: 600;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      @media (min-width: 640px) {
        .price-modal__content {
          width: 600px;
          height: fit-content;
          padding: 2.5rem;
          position: absolute;
          left: 50%;
          top: 50%;
          transform: translateX(-50%) translateY(-50%);
        }

        .price-modal__prices {
          width: 506px;
          grid-template-rows: none;
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .price-modal__price {
          align-items: start;
        }

        .price-modal__perks {
          margin-top: 1rem;
        }
      }

      /* Rest of your existing styles */
      #text-discord {
        color: #404040;
        margin-top: -3px;
      }

      .nav-link-wrapper svg {
        width: 16px;
        height: 16px;
        margin-right: 8px;
        vertical-align: middle;
      }

      .nav-link-wrapper a {
        display: inline-flex;
        align-items: center;
        text-decoration: underline;
        color: black;
      }

      .nav-link-wrapper a:hover {
        text-decoration: underline;
      }

      .nav-link {
        text-decoration: underline;
      }

      .header-content__logo-container {
        display: flex;
        flex-direction: row;
        gap: 1rem;
        align-items: center;
      }

      .header-content__logo-container img {
        height: 32px;
        width: auto;
      }

      .header-content__button-container {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .header-content__sign-in-button {
        background: transparent;
        color: var(--primary-blue);
        font-weight: 600;
        padding: 8px 16px;
        border-radius: var(--radius-md);
        transition: var(--transition);
      }

      .header-content__sign-in-button:hover {
        background: rgba(0, 102, 255, 0.1);
        color: var(--primary-blue);
      }

      .header-content__get_started-button {
        background: var(--primary-blue);
        color: white;
        font-weight: 600;
        padding: 8px 16px;
        border-radius: var(--radius-md);
        transition: var(--transition);
      }

      .header-content__get_started-button:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
      }

      .header-content__greeting {
        font-size: 1rem;
        font-weight: 600;
      }

      /* Additional utility styles */
      .nav-content {
        display: none;
      }

      .nav-content.active {
        display: block;
      }

      button:disabled {
        background-color: #c0c0c0;
        cursor: not-allowed;
      }

      input[type="text"] {
        width: 40%;
        padding: 0.5em;
        margin: 0.5em 0;
        box-sizing: border-box;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-family: inherit;
      }

      button {
        font-family: inherit;
        font-weight: 500;
        background-color: var(--btn-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.5em 1em;
        cursor: pointer;
        transition: background-color 200ms ease-in-out;
        text-decoration: none;
      }

      button:hover {
        background-color: var(--btn-color-hover);
      }

      /* Main Page Styles - Modern Design */
      .nav-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
        margin-bottom: 40px;
      }

      .nav-card {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: 32px;
        box-shadow: var(--shadow-md);
        transition: var(--transition);
      }

      .nav-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
      }

      .nav-card h2 {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 24px;
        color: var(--text-primary);
      }

      .nav-link-wrapper {
        display: flex;
        align-items: center;
        padding: 12px;
        margin: -12px;
        border-radius: var(--radius-md);
        color: var(--text-primary);
        text-decoration: none;
        transition: var(--transition);
      }

      .nav-link-wrapper:hover {
        background: var(--background);
        color: var(--primary-blue);
      }

      .nav-link-wrapper span:first-child {
        font-size: 20px;
        margin-right: 12px;
      }

      .license-section {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: 32px;
        box-shadow: var(--shadow-md);
        margin-bottom: 24px;
      }

      .license-section h2 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 16px;
      }

      .license-section p {
        color: var(--text-secondary);
        margin-bottom: 24px;
      }

      input[type="text"] {
        width: 100%;
        max-width: 400px;
        padding: 12px 16px;
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 16px;
        transition: var(--transition);
        margin-bottom: 16px;
      }

      input[type="text"]:focus {
        border-color: var(--primary-blue);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
      }

      button {
        background: var(--primary-blue);
        color: white;
        font-weight: 600;
        padding: 12px 24px;
        border-radius: var(--radius-md);
        border: none;
        cursor: pointer;
        transition: var(--transition);
      }

      button:hover:not(:disabled) {
        background: var(--primary-hover);
        transform: translateY(-1px);
      }

      button:disabled {
        background: var(--text-secondary);
        cursor: not-allowed;
      }

      .setting-item {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: 32px;
        box-shadow: var(--shadow-md);
        margin-bottom: 24px;
      }

      .setting-item h2 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 16px;
      }

      .setting-item p {
        color: var(--text-secondary);
        margin-bottom: 24px;
      }

      label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--text-primary);
      }

      #about {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: 32px;
        box-shadow: var(--shadow-md);
      }

      #about h2 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 16px;
      }

      #about p {
        color: var(--text-secondary);
        margin-bottom: 16px;
      }

      #about a {
        color: var(--primary-blue);
        text-decoration: none;
        font-weight: 500;
        transition: var(--transition);
      }

      #about a:hover {
        text-decoration: underline;
      }

      /* Additional Animations */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .nav-section {
        animation: fadeIn 0.5s ease-out;
      }

      .license-section, .setting-item, #about {
        animation: fadeIn 0.5s ease-out;
        animation-fill-mode: both;
      }

      .license-section { animation-delay: 0.1s; }
      .setting-item { animation-delay: 0.2s; }
      #about { animation-delay: 0.3s; }
    </style>
  </head>

  <body>
    <header>
      <div class="header-content">
        <div class="container">
        <div class="header-content__logo-container">
            <img src="/logo/photosolve-text-icon.png" alt="PhotoSolve Logo" style="width: 160px; height: auto;">
        </div>
        <div class="header-content__button-container">
            <button class="header-content__sign-in-button" id="sign-in-button">Sign In</button>
            <button class="header-content__get_started-button" id="get-started-button">Get Started</button>
          <div class="header-content__greeting" id="greeting" hidden>
              Hi, <span id="user-name"></span>!
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="main-wrapper">
      <div class="main-content">
        <div class="nav-section">
          <div class="nav-card">
            <h2>Quick Actions</h2>
            <a href="#" class="nav-link-wrapper" id="buy-license">
              <span>⚡</span>
              <span>Buy license key</span>
            </a>
            <a href="#" class="nav-link-wrapper" id="input_license_key">
              <span>🔑</span>
              <span>Input license key</span>
            </a>
            <a href="#" class="nav-link-wrapper" id="settings_link">
              <span>⚙️</span>
              <span>Settings</span>
            </a>
          </div>

          <div class="nav-card">
            <h2>Support</h2>
            <a href="#" class="nav-link-wrapper" id="about_link">
              <span>👥</span>
              <span>About</span>
            </a>
            <a href="https://discord.gg/sdGYm7kNrB" class="nav-link-wrapper" target="_blank">
              <svg class="discord-icon" viewBox="0 -28.5 256 256" xmlns="http://www.w3.org/2000/svg">
                <path d="M216.856339,16.5966031 C200.285002,8.84328665 182.566144,3.2084988 164.041564,0 C161.766523,4.11318106 159.108624,9.64549908 157.276099,14.0464379 C137.583995,11.0849896 118.072967,11.0849896 98.7430163,14.0464379 C96.9108417,9.64549908 94.1925838,4.11318106 91.8971895,0 C73.3526068,3.2084988 55.6133949,8.86399117 39.0420583,16.6376612 C5.61752293,67.146514 -3.4433191,116.400813 1.08711069,164.955721 C23.2560196,181.510915 44.7403634,191.567697 65.8621325,198.148576 C71.0772151,190.971126 75.7283628,183.341335 79.7352139,175.300261 C72.104019,172.400575 64.7949724,168.822202 57.8887866,164.667963 C59.7209612,163.310589 61.5131304,161.891452 63.2445898,160.431257 C105.36741,180.133187 151.134928,180.133187 192.754523,160.431257 C194.506336,161.891452 196.298154,163.310589 198.110326,164.667963 C191.183787,168.842556 183.854737,172.420929 176.223542,175.320965 C180.230393,183.341335 184.861538,190.991831 190.096624,198.16893 C211.238746,191.588051 232.743023,181.531619 254.911949,164.955721 C260.227747,108.668201 245.831087,59.8662432 216.856339,16.5966031 Z" fill="#5865F2"/>
              </svg>
              <span>Join our discord</span>
            </a>
          </div>
        </div>

        <div class="license-section">
          <h2>License Key</h2>
          <p>Enter your license key below to activate the pro features.</p>
          <div class="input-group">
            <input type="text" id="license_key_input" name="license_key_input" placeholder="Enter your license key here"/>
            <button id="save_license_key">Save License Key</button>
          </div>
          <p id="license_key_status"></p>
          <p class="no-license" id="no_license">Don't have a license key yet?</p>
          <button id="upgrade" class="upgrade">Upgrade to PhotoSolve Pro</button>
        </div>

        <div class="setting-item">
          <h2>Settings</h2>
          <p>Configure extension settings here.</p>
          <label for="stealth_shortcut">Stealth Mode Shortcut:</label>
          <div class="input-group">
            <input 
              type="text" 
              id="stealth_shortcut" 
              name="stealth_shortcut" 
              placeholder="Press keys to set shortcut" 
              readonly
              autocomplete="off"
            />
            <button id="save_settings">Save Settings</button>
          </div>
          <p id="settings_status"></p>
        </div>

        <div id="about">
          <h2>About PhotoSolve</h2>
          <p>PhotoSolve is an AI-powered Chrome extension that instantly provides accurate answers.</p>
          <p>PhotoSolve is built by <a target="_blank" href="https://photosolve.io/">PhotoSolve Team</a></p>
          <p>You are using version: <code id="version">4.1.6</code></p>
          <p><a href="https://wa.me/13309342442" target="_blank">Contact us</a></p>
        </div>
      </div>
    </main>

    <div id="price-modal" class="price-modal">
      <div
        id="price-modal-loading-overlay"
        class="price-modal__loading-overlay"
        style="display: none"
      >
        <img
          src="/icons/loading.svg"
          alt="Loading Spinner"
          class="price-modal__loading-spinner"
        />
      </div>
      <div id="price-modal-content" class="price-modal__content">
        <img
          src="/assets/math_scribbles.svg"
          alt="Math Scribbles on Price Modal"
          class="price-modal__content-background"
        />
        <button id="close-price-modal" class="price-modal__close-button">
          <img
            src="/icons/x.svg"
            alt="Cross"
            class="price-modal__close-button-icon"
          />
        </button>
        <div class="price-modal__pro-header">
          <img
            src="/logo/photosolve-logo-text-white.svg"
            alt="PhotoSolve Logo"
          />
          <span class="price-modal__pro-chip">PRO</span>
        </div>
        <h1 style="font-weight: bold">Get Better Grades in Less Time!</h1>
        <div class="price-modal__prices">
          <div class="price-modal__price" data-plan="yearly" data-selected="true">
            <div class="price-modal__discount-badge">-50% off</div>
            <div class="price-modal__radio"></div>
            <div class="price-modal__price-type">Yearly Pro</div>
            <div class="price-modal__price-value">
              $4.99
              <span class="price-modal__price-original">$9.99</span>
            </div>
            <div class="price-modal__price-currency">in USD / Month</div>
          </div>
          <div class="price-modal__price" data-plan="monthly" data-selected="false">
            <div class="price-modal__radio"></div>
            <div class="price-modal__price-type">Monthly Pro</div>
            <div class="price-modal__price-value">$9.00</div>
            <div class="price-modal__price-currency">in USD / Month</div>
          </div>
        </div>
        <button class="price-modal__checkout-button">
          <span>Get PhotoSolve Pro</span>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M13.75 6.75L19.25 12L13.75 17.25" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19 12H4.75" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <ul class="price-modal__perks">
          <li class="price-modal__perk">
            <img src="/icons/checkmark.svg" alt="Blue Checkmark Icon" />
            <p class="price-modal__perk-description">
              <strong>Unlimited Access</strong> - for the
              Extension, Mobile App, Tutoor.com, and Homework Solver
            </p>
          </li>
          <li class="price-modal__perk">
            <img src="/icons/checkmark.svg" alt="Blue Checkmark Icon" />
            <p class="price-modal__perk-description">
              <strong>Unlimited Answers</strong> - Ask questions and get
              learning resources
            </p>
          </li>
          <li class="price-modal__perk">
            <img src="/icons/checkmark.svg" alt="Blue Checkmark Icon" />
            <p class="price-modal__perk-description">
              <strong>Better Accuracy</strong> - Enjoy more accurate and
              detailed answers.
            </p>
          </li>
        </ul>
      </div>
    </div>
    <div id="error"></div>
    <script src="index.js"></script>
    <script>
      console.log('Script loaded');

      function requestTokenFromBackground(callback) {
        console.log('Requesting token...');
        chrome.runtime.sendMessage({ message: "generate_token" }, (response) => {
          console.log('Token response:', response);
          if (response && response.message === "token_generated") {
            callback(response.payload);
          } else {
            console.error('Failed to get token:', response);
          }
        });
      }

      /*** Subscription Management ***/
      const modal = document.getElementById("price-modal");
      const modalContent = document.getElementById("price-modal-content");
      const modalSpinner = document.getElementById("price-modal-loading-overlay");

      function openPriceModal() {
        modal.style.display = "block";
        document
          .getElementsByTagName("body")
          .item(0)
          .classList.add("price-modal__open");
      }

      function closePriceModal() {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.delete("prices");

        window.history.replaceState(
          "",
          null,
          window.location.pathname + "?" + urlParams
        );

        modal.style.display = "none";
        modalContent.style.display = "flex";
        modalSpinner.style.display = "none";

        document
          .getElementsByTagName("body")
          .item(0)
          .classList.remove("price-modal__open");
      }

      function checkoutSubscriptionFromBackground(event) {
        modalContent.style.display = "none";
        modalSpinner.style.display = "flex";

        chrome.runtime.sendMessage(
          { event: "checkout_subscription", price: event.currentTarget.value },
          (response) => {
            if (!response) {
              alert("Something went wrong");
            }
            closePriceModal();
          }
        );
      }

      window.onload = function (event) {
        const prices = document.getElementsByClassName("price-modal__price");

        for (const price of prices) {
          price.onclick = checkoutSubscriptionFromBackground;
        }
      };

      document.getElementById("buy-license").onclick = openPriceModal;
      document.getElementById("upgrade").onclick = openPriceModal;
      document.getElementById("close-price-modal").onclick = closePriceModal;

      document.onclick = function (event) {
        if (event.target == modal) {
          closePriceModal();
        }
      };

      /*** SSO Management ***/
      function getSsoAuthorizationFromBackground(event) {
        event.preventDefault();
        chrome.runtime.sendMessage(
          { event: "auth_authorize" },
          (response) => {
            if (!response) {
              alert("Something went wrong");
            }
          }
        );
      }

      function getUserInfoFromBackground(callback) {
        chrome.runtime.sendMessage(
          { event: "get_user_info" },
          (response) => {
            if (!response) {
              alert("Something went wrong");
              return;
            }
            if (callback) {
              callback();
            }
          }
        );
      }

      function putLicenseKeyFromBackground() {
        chrome.runtime.sendMessage(
          { event: "put_license_key" },
          (response) => {
            if (!response) {
              alert("Something went wrong");
            }
          }
        );
      }

      document.addEventListener("DOMContentLoaded", () => {
        console.log('DOM Content Loaded');
        
        // License Key Section
        const licenseKeyInput = document.getElementById("license_key_input");
        const saveLicenseKeyButton = document.getElementById("save_license_key");
        const licenseKeyStatus = document.getElementById("license_key_status");
        const noLicense = document.getElementById("no_license");
        const upgradeButton = document.getElementById("upgrade");

        console.log('Elements found:', {
          licenseKeyInput: !!licenseKeyInput,
          saveLicenseKeyButton: !!saveLicenseKeyButton,
          licenseKeyStatus: !!licenseKeyStatus,
          noLicense: !!noLicense,
          upgradeButton: !!upgradeButton
        });

        function handleLicenseKeyValid() {
          console.log('Handling valid license key');
          licenseKeyInput.disabled = true;
          saveLicenseKeyButton.disabled = true;
          noLicense.hidden = true;
          upgradeButton.hidden = true;
        }

        // Check if license key exists
        chrome.storage.sync.get(["deviceId", "license_key", "isPro"], (data) => {
          console.log('Storage data:', data);
          if (data.isPro) {
            licenseKeyInput.value = data.license_key;
            handleLicenseKeyValid();
          } else {
            licenseKeyInput.placeholder = "8D248C59-3DCD4033-B41E8890-845FDBAD";
            noLicense.hidden = false;
            upgradeButton.hidden = false;
          }
        });

        // Save License Key
        if (saveLicenseKeyButton) {
          console.log('Adding click listener to save button');
          saveLicenseKeyButton.onclick = function() {
            console.log('Save button clicked');
            const license_key = licenseKeyInput.value;
            console.log('License key:', license_key);
            
            if (!license_key) {
              console.log('No license key entered');
              licenseKeyStatus.textContent = "Please enter a license key";
              return;
            }

            saveLicenseKeyButton.disabled = true;
            licenseKeyStatus.textContent = "Verifying license key...";

            requestTokenFromBackground((token) => {
              console.log('Got token, making fetch request');
              fetch("http://coral-app-opv8j.ondigitalocean.app/verify_license", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ license_key: license_key }),
              })
                .then((res) => {
                  console.log('Got response:', res);
                  return res.json();
                })
                .then((data) => {
                  console.log('Response data:', data);
                  if (data.success) {
                    chrome.storage.sync.set({
                      deviceId: data.deviceId,
                      license_key: license_key,
                      isPro: true,
                    }).then(() => {
                      console.log('Storage updated');
                      chrome.storage.sync.get("uid", function (result) {
                        if (result.uid) {
                          putLicenseKeyFromBackground();
                        }
                      });
                    });
                    licenseKeyStatus.textContent = "License key valid!";
                    handleLicenseKeyValid();
                  } else {
                    console.log('Invalid license key');
                    licenseKeyStatus.textContent = "Invalid license key!";
                    saveLicenseKeyButton.disabled = false;
                  }
                })
                .catch((err) => {
                  console.error("Error verifying license key:", err);
                  licenseKeyStatus.textContent = "Error verifying license key. Please try again.";
                  saveLicenseKeyButton.disabled = false;
                });
            });
          };
        }

        // Navigation
        const inputLicenseKeyLink = document.getElementById("input_license_key");
        const aboutLink = document.getElementById("about_link");
        const settingsLink = document.getElementById("settings_link");
        const licenseKeyContent = document.querySelector(".license-section");
        const aboutContent = document.getElementById("about");
        const settingsContent = document.querySelector(".setting-item");

        // Show active section based on URL
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get("tab");

        if (activeTab === "settings") {
          licenseKeyContent.style.display = "none";
          aboutContent.style.display = "none";
          settingsContent.style.display = "block";
        } else if (activeTab === "license_key" || !activeTab) {
          aboutContent.style.display = "none";
          settingsContent.style.display = "none";
          licenseKeyContent.style.display = "block";
        } else if (activeTab === "about") {
          licenseKeyContent.style.display = "none";
          settingsContent.style.display = "none";
          aboutContent.style.display = "block";
        }

        // Navigation click handlers
        inputLicenseKeyLink.addEventListener("click", (event) => {
          event.preventDefault();
          aboutContent.style.display = "none";
          settingsContent.style.display = "none";
          licenseKeyContent.style.display = "block";
        });

        aboutLink.addEventListener("click", (event) => {
          event.preventDefault();
          licenseKeyContent.style.display = "none";
          settingsContent.style.display = "none";
          aboutContent.style.display = "block";
        });

        settingsLink.addEventListener("click", (event) => {
          event.preventDefault();
          licenseKeyContent.style.display = "none";
          aboutContent.style.display = "none";
          settingsContent.style.display = "block";
        });

        // Settings Section
        const stealthShortcutInput = document.getElementById("stealth_shortcut");
        const saveSettingsButton = document.getElementById("save_settings");
        const settingsStatus = document.getElementById("settings_status");

        // Load saved shortcut
        chrome.storage.sync.get(["stealthShortcut"], (data) => {
          if (data.stealthShortcut) {
            stealthShortcutInput.value = data.stealthShortcut;
          } else {
            if (navigator.platform.toLowerCase().includes("win")) {
              stealthShortcutInput.value = "Ctrl+Shift+Q";
              chrome.storage.sync.set({ stealthShortcut: "Ctrl+Shift+Q" });
            } else if (navigator.platform.toLowerCase().includes("mac")) {
              stealthShortcutInput.value = "Command+Shift+Q";
              chrome.storage.sync.set({ stealthShortcut: "Command+Shift+Q" });
            }
          }
        });

        // Record shortcut
        stealthShortcutInput.addEventListener("keydown", (event) => {
          event.preventDefault();
          const modifiers = [];

          if (event.ctrlKey) modifiers.push("Ctrl");
          if (event.shiftKey) modifiers.push("Shift");
          if (event.altKey) modifiers.push("Alt");
          if (event.metaKey) modifiers.push("Command");

          const shortcut = `${modifiers.join("+")}+${event.key.toUpperCase()}`;
          stealthShortcutInput.value = shortcut;
        });

        // Save settings
        saveSettingsButton.addEventListener("click", () => {
          const stealthShortcut = stealthShortcutInput.value;
          chrome.storage.sync.set({ stealthShortcut: stealthShortcut }, () => {
            settingsStatus.textContent = "Settings saved!";
            chrome.runtime.sendMessage({
              message: "updateStealthShortcut",
              shortcut: stealthShortcut,
            });
          });
        });

        // SSO Section
        const signInButton = document.getElementById("sign-in-button");
        const getStartedButton = document.getElementById("get-started-button");
        const greeting = document.getElementById("greeting");
        const userNameSpan = document.getElementById("user-name");

        function showName() {
          chrome.storage.sync.get("name", function (result) {
            if (result.name) {
              userNameSpan.textContent = result.name.split(" ")[0];
              greeting.hidden = false;
              signInButton.hidden = true;
              getStartedButton.hidden = true;
            } else {
              signInButton.hidden = false;
              getStartedButton.hidden = false;
              greeting.hidden = true;
            }
          });
        }

        signInButton.addEventListener("click", getSsoAuthorizationFromBackground);
        getStartedButton.addEventListener("click", getSsoAuthorizationFromBackground);

        getUserInfoFromBackground(showName);
      });
    </script>
  </body>
</html>

