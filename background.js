(()=>{"use strict";var e,t;!function(e){e.START_PROCESSING="scan:start_processing",e.EXIT_SCAN="scan:exit"}(e||(e={})),function(e){e.BASIC_AI="Basic AI",e.POWERFUL_AI="Powerful AI",e.GPT_O1="GPT-o1",e.GEMINI_PRO="Gemini Pro",e.WOLFRAM_ALPHA="WolframeAlpha",e.CLAUDE_SONNET="Claude 3.5 Sonnet",e.CLAUDE_HAIKU="Claude 3.5 Haiku",e.PERPLEXITY="Preplexity",e.CHEGG="Chegg",e.GPT_4O="GPT-4o"}(t||(t={}));var s;!function(e){e.ANALYZING_IMAGE="Analyzing Image",e.QUESTIONS_TYPE="Questions Type",e.SUBJECT="Subject",e.LEARNING_CONCEPT="Learning Concept",e.LEARNING_RESOURCES="Learning Resources"}(s||(s={}));var o=function(e,t,s,o){return new(s||(s=Promise))((function(n,i){function a(e){try{c(o.next(e))}catch(e){i(e)}}function r(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((o=o.apply(e,t||[])).next())}))};var n=function(e,t,s,o){return new(s||(s=Promise))((function(n,i){function a(e){try{c(o.next(e))}catch(e){i(e)}}function r(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((o=o.apply(e,t||[])).next())}))};let i=!1,a=null;function r(e,t=100){chrome.tabs.query({active:!0,currentWindow:!0},(function(s){s&&s.length>0&&""!==s[0].url&&"complete"===s[0].status?e(s[0].id):setTimeout((()=>{r(e,t)}),t)}))}function c(t,s){chrome.runtime.onMessage.addListener(((t,o,c)=>{if("scan"===t.message)r((e=>{chrome.scripting.executeScript({target:{tabId:e},files:["./helper/content.js"]})}));else{if("capture"===t.message)return chrome.runtime.lastError?void c({message:"fail"}):(chrome.tabs.captureVisibleTab(null,null,(function(e){c({message:"captured_successfully",payload:e})})),!0);if("cropped_dataUrl_sent"===t.message){a&&a.abort(),a=new AbortController,s=a.signal,chrome.storage.sync.get(["isPro","license_key","deviceId","stealthMode","limit","imageVision","powerfulAI"],(s=>{r((o=>{chrome.tabs.sendMessage(o,{command:e.START_PROCESSING,image:t.payload,data:s})}))}));const o=new FormData,c=function(e){const t=e.split(","),s=t[0].match(/:(.*?);/)[1],o=atob(t[1]);let n=o.length,i=new Uint8Array(n);for(;n--;)i[n]=o.charCodeAt(n);return new Blob([i],{type:s})}(t.payload);o.append("image",c,"image.png"),chrome.storage.sync.get(["isPro","license_key","deviceId","stealthMode","limit"],(e=>{const t=!e.isPro&&e.limit>=10,a=e.stealthMode||!1;if(e.isPro&&(o.append("license_key",e.license_key),o.append("deviceId",e.deviceId)),t)return r((e=>{chrome.scripting.executeScript({target:{tabId:e},func:()=>{const e=document.getElementById("wait_main");e&&document.querySelector("body").removeChild(e)}})})),void r((e=>{chrome.tabs.sendMessage(e,{data:{answer:"Limit Reached",question:"You have reached the maximum number of scans. Please upgrade to pro version to continue using Photosolve",subject:"Limit Reached"},command:"image_processed"})}));{let e="process_image";chrome.storage.sync.get(["imageVision","powerfulAI","isPro"],(t=>{t.isPro?t.imageVision&&t.powerfulAI||t.imageVision?e="process_image_vision":t.powerfulAI&&(e="process_image_pro"):t.imageVision&&(e="process_image_vision"),r(a?e=>{chrome.tabs.sendMessage(e,{command:"show_stealth_loading"})}:e=>{chrome.scripting.executeScript({target:{tabId:e},files:["./helper/wait.js"]},(()=>{chrome.scripting.insertCSS({target:{tabId:e},files:["./helper/wait.css"]})}))}),e="process_image_vision",fetch(`https://coral-app-opv8j.ondigitalocean.app/${e}`,{method:"POST",body:o,signal:s}).then((t=>{if(chrome.storage.sync.get(["limit","isPro"],(e=>{!e.isPro&&e.limit<10&&chrome.storage.sync.set({limit:e.limit+0})})),"process_image_vision"!==e)return t.json().then((e=>(r((t=>{chrome.tabs.sendMessage(t,{data:e,command:"image_processed"})})),e)));{const e=t.body.getReader(),s=()=>n(this,void 0,void 0,(function*(){try{const{done:t,value:o}=yield e.read(),n=new TextDecoder("utf-8").decode(o);if(t)return i=!0,void r((e=>{chrome.tabs.sendMessage(e,{command:"image_processed_final"})}));let a=n.split("\n").filter((e=>""!==e.trim()));for(let e of a)try{const t=JSON.parse(e);r((e=>{chrome.tabs.sendMessage(e,{data:Object.assign({},t),command:"image_processed_partial"})}))}catch(e){}yield s()}catch(e){console.error("Error in readChunk:",e)}}));s()}}))}))}}))}else if("cancel_popup"===t.message)a&&(a.abort(),a=null),r((e=>{chrome.tabs.sendMessage(e,{command:"remove_loading"})})),c({status:"cancelled"});else{if("editQuestion"===t.message)return chrome.storage.sync.get(["limit","isPro"],(e=>{fetch("https://coral-app-opv8j.ondigitalocean.app/process_text",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t.text})}).then((e=>e.json())).then((t=>{c(t),!e.isPro&&e.limit<10&&chrome.storage.sync.set({limit:e.limit+0})}))})),!0;if("close_scan_question"===t.message)r((e=>{chrome.tabs.sendMessage(e,{command:"close_scan_question"})}));else if("activateStealthMode"===t.message)r((e=>{chrome.scripting.executeScript({target:{tabId:e},files:["./helper/content2.js"]},(()=>{}))}));else if("check_tab_status"===t.message)return r((e=>{c({status:"active"})})),!0}}})),chrome.storage.sync.get(["stealthShortcut"],(e=>{if(!e.stealthShortcut){const e=navigator.platform.toUpperCase().includes("MAC")?"Command+Shift+2":"Ctrl+Shift+Q";chrome.storage.sync.set({stealthShortcut:e})}})),chrome.storage.sync.get(["stealthMode","limit","isPro","stealthShortcut"],(e=>{if(!0===e.stealthMode&&(e.limit<10||e.isPro)){const t=(e.stealthShortcut||"Ctrl+Shift+Q").split("+");console.log("Stealth mode settings:",e),console.log("Shortcut keys:",t),document.addEventListener("keydown",(e=>{const s=[];e.ctrlKey&&s.push("Ctrl"),e.shiftKey&&s.push("Shift"),e.altKey&&s.push("Alt"),e.metaKey&&s.push("Command"),s.push(e.key.toUpperCase()),t.length===s.length&&t.every((e=>s.includes(e)))&&r((e=>{chrome.scripting.executeScript({target:{tabId:e},files:["./helper/content2.js"]},(()=>{}))}))}))}})),document.addEventListener("visibilitychange",(function(){document.hidden,0}))}var l=function(e,t,s,o){return new(s||(s=Promise))((function(n,i){function a(e){try{c(o.next(e))}catch(e){i(e)}}function r(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((o=o.apply(e,t||[])).next())}))};try{let t=null,s=null;chrome.runtime.onInstalled.addListener((()=>{chrome.storage.sync.get(["isPro","limit"],(e=>{void 0===e.limit&&chrome.storage.sync.set({limit:0}),void 0===e.isPro&&chrome.storage.sync.set({isPro:!1})}))})),chrome.runtime.onMessage.addListener(((e,t,s)=>("generate_token"===e.message&&function(){return o(this,void 0,void 0,(function*(){const e=new TextEncoder,t=String((new Date).getTime()),s=yield crypto.subtle.importKey("raw",e.encode("u287L0EKjczkjmzSIgTZp9LP7WHJCmJE"),{name:"HMAC",hash:"SHA-256"},!1,["sign"]),o=yield crypto.subtle.sign("HMAC",s,e.encode(t));return Array.from(new Uint8Array(o)).map((e=>e.toString(16).padStart(2,"0"))).join("")+"."+t}))}().then((e=>{s({message:"token_generated",payload:e})})),!0))),chrome.runtime.onMessage.addListener(((e,t,s)=>{if("checkout_subscription"===e.event&&fetch(`https://coral-app-opv8j.ondigitalocean.app/checkout?price=${e.price}`).then((e=>{200===e.status?e.json().then((e=>{void 0!==e.url?(chrome.tabs.create({url:e.url,active:!0}),s(!0)):s(!1)})):s(!1)})).catch((e=>{s(!1)})),"open_license_key_page"===e.event){let t="pages/pro/index.html?tab=license_key";e.showPrices&&(t+="&prices=show"),chrome.tabs.create({url:chrome.runtime.getURL(t)})}})),function(){function e(e){return l(this,void 0,void 0,(function*(){try{yield fetch("https://coral-app-opv8j.ondigitalocean.app/license",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:e})})}catch(e){console.error("Error while putting license key:",e)}}))}chrome.runtime.onMessage.addListener(((t,s,o)=>l(this,void 0,void 0,(function*(){if("auth_authorize"!==t.event){if("get_user_info"!=t.event)return"put_license_key"==t.event?(chrome.storage.sync.get(["license_key"],(t=>l(this,void 0,void 0,(function*(){yield e(t.license_key)})))),void o(!0)):void 0;yield function(t){return l(this,void 0,void 0,(function*(){const s=yield fetch("https://coral-app-opv8j.ondigitalocean.app/auth/self");if(200===s.status){const o=yield s.json();o.license_key&&"free"!=o.subscription&&"expired"!=o.subscription?chrome.storage.sync.set({license_key:o.license_key,isPro:!0}):chrome.storage.sync.get(["license_key"],(t=>l(this,void 0,void 0,(function*(){yield e(t.license_key)})))),yield chrome.storage.sync.set({name:o.name,email:o.email,uid:o.uid}),t(!0)}else yield chrome.storage.sync.set({name:"",email:"",uid:""}),t(!0)}))}(o)}else{const e=chrome.runtime.getURL("pages/pro/index.html"),t=new URLSearchParams({client_redirect_uri:e});try{const e=yield fetch(`https://coral-app-opv8j.ondigitalocean.app/auth/authorize?${t.toString()}`,{redirect:"manual"});if(e.url)return chrome.tabs.update({url:e.url}),void o(!0);o(!1)}catch(e){console.error("Error during authorization:",e),o(!1)}}}))))}(),chrome.runtime.onMessage.addListener(((o,n,i)=>{if("aitutor"===o.message)chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e.length>0&&chrome.tabs.sendMessage(e[0].id,"aitutor")})),i(!0);else if("askAITutor"===o.message&&o.question)chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e.length>0&&chrome.tabs.sendMessage(e[0].id,{message:"askAITutor",question:o.question})})),i(!0);else if("updateStealthShortcut"===o.message){const e=o.shortcut;chrome.storage.sync.set({stealthShortcut:e},(()=>{}))}else if("check_tab_status"===o.message)return chrome.tabs.query({active:!0,currentWindow:!0},(e=>{var t;e.length>0&&(null===(t=n.tab)||void 0===t?void 0:t.id)===e[0].id?i({status:"active"}):i({status:"inactive"})})),!0;"cancel_popup"===o.message?(t&&(t.abort(),t=null),i({status:"cancelled"})):"scan"===o.message?(t&&t.abort(),t=new AbortController,s=t.signal,chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e.length>0&&chrome.tabs.sendMessage(e[0].id,"scan")})),i(!0)):o.message===e.EXIT_SCAN&&(chrome.tabs.query({active:!0,currentWindow:!0},(t=>{t.length>0&&chrome.tabs.sendMessage(t[0].id,{command:e.EXIT_SCAN})})),i(!0))})),chrome.runtime.onMessage.addListener(((e,t,s)=>{if("get_answer"===e.message.command)return chrome.storage.sync.get(["limit","isPro","license_key"],(t=>{t.isPro||t.limit<10?fetch("https://coral-app-opv8j.ondigitalocean.app/ai_tutor_v2",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Object.assign({history:e.message.payload},t.isPro&&{licenseKey:t.license_key}))}).then((e=>e.text())).then((e=>{t.isPro||chrome.storage.sync.get(["limit"],(e=>{const t=Math.min((e.limit||0)+1,10);chrome.storage.sync.set({limit:t})})),e.endsWith("None")?s({status:"success",data:e.slice(0,-4)}):s({status:"success",data:e})})).catch((e=>{s({status:"error",data:`An error occurred: ${e}`})})):s({status:"error",data:"Limit reached. Please upgrade to continue using AI Tutor."})})),!0;if("ssAITutor"===e.message)chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.scripting.executeScript({target:{tabId:e[0].id},files:["./helper/ssaitutor.js"]})}));else{if("capture_ss"===e.message)return chrome.runtime.lastError?void s({message:"fail"}):(setTimeout((()=>{chrome.tabs.captureVisibleTab(null,null,(function(e){s({message:"captured_successfully",payload:e})}))}),500),!0);"ss_dataUrl_sent"===e.message&&chrome.tabs.query({active:!0,currentWindow:!0},(function(t){t[0]&&chrome.tabs.sendMessage(t[0].id,{message:"image_sent",payload:e.payload})}))}})),chrome.runtime.onConnect.addListener((e=>{e.onMessage.addListener((t=>{"get_answer"===t.message.command?chrome.storage.sync.get(["limit","isPro"],(s=>{s.isPro||s.limit<10?fetch("https://coral-app-opv8j.ondigitalocean.app/ai_tutor_v2",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.payload)}).then((t=>{const o=t.body.getReader(),n=()=>{o.read().then((({done:t,value:o})=>{if(t)return s.isPro||chrome.storage.sync.get(["limit"],(e=>{const t=Math.min((e.limit||0)+1,10);chrome.storage.sync.set({limit:t},(()=>{}))})),void e.postMessage({status:"done"});let i=new TextDecoder("utf-8").decode(o);return e.postMessage({status:"streaming",data:i}),n()}))};n()})).catch((t=>{e.postMessage({status:"error",data:`An error occurred: ${t}`})})):e.postMessage({status:"error",data:"Limit reached. Please upgrade to continue using AI Tutor."})})):"aiTutorImage"===t.message.command&&chrome.storage.sync.get(["limit","isPro"],(s=>{if(s.isPro||s.limit<10){const o=new FormData,n=function(e){const t=atob(e.split(",")[1]),s=[];for(let e=0;e<t.length;e++)s.push(t.charCodeAt(e));const o=new Blob([new Uint8Array(s)],{type:e.type});return new File([o],e.name,{type:e.type})}(t.payload.image);o.append("image",n,"image.png"),o.append("licenseKey",t.payload.licenseKey),o.append("isGpt4",t.payload.isGpt4),o.append("history",t.payload.history),fetch("https://coral-app-opv8j.ondigitalocean.app/ai_tutor_with_image_v2",{method:"POST",body:o}).then((t=>{const o=t.body.getReader(),n=()=>{o.read().then((({done:t,value:s})=>{if(t)return void e.postMessage({status:"done"});let o=new TextDecoder("utf-8").decode(s);return e.postMessage({status:"streaming",data:o}),n()}))};n(),s.isPro||chrome.storage.sync.get(["limit"],(e=>{const t=Math.min((e.limit||0)+1,1000);chrome.storage.sync.set({limit:t})}))})).catch((t=>{e.postMessage({status:"error",data:`An error occurred: ${t}`})}))}else e.postMessage({status:"error",data:"Limit reached. Please upgrade to continue using AI Tutor."})}))}))}));try{Promise.resolve().then((()=>{c(0,s)})).catch((e=>{console.error("Error in scanVer2:",e)})),console.log("After calling scanVer2")}catch(e){console.error("Error during scanVer2 setup:",e)}chrome.runtime.onInstalled.addListener((()=>{chrome.contextMenus.create({id:"solveWithPhotosolveMenu",title:"Solve with PhotoSolve",contexts:["selection"]},(()=>{chrome.runtime.lastError&&console.error("Error creating context menu:",chrome.runtime.lastError)}))})),chrome.contextMenus.onClicked.addListener(((e,t)=>{(null==t?void 0:t.id)&&chrome.storage.sync.get(["limit","isPro","stealthMode"],(s=>{!s.isPro&&s.limit>=10?r((e=>{chrome.tabs.sendMessage(e,{answer:"Limit Reached",question:"You have reached the maximum number of scans. Please upgrade to pro version to continue using Photosolve",subject:"Limit Reached",command:"image_processed"})})):(s.stealthMode?(console.log("Debug: Showing stealth loading screen."),r((e=>{chrome.tabs.sendMessage(e,{command:"show_stealth_loading"})}))):r((e=>{chrome.scripting.executeScript({target:{tabId:e},files:["./helper/wait.js"]},(()=>{chrome.scripting.insertCSS({target:{tabId:e},files:["./helper/wait.css"]})}))})),fetch("https://coral-app-opv8j.ondigitalocean.app/process_text",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e.selectionText})}).then((e=>e.json())).then((e=>{chrome.tabs.sendMessage(t.id,Object.assign(Object.assign({},e),{command:s.stealthMode?"image_processed_stealth":"image_processed"})),!s.isPro&&s.limit<10&&chrome.storage.sync.set({limit:s.limit+1})})))}))}))}catch(e){}})();